@page "/invoicing"
@inject IDbContextFactory<OfflineDbContext> DbFactory
@inject ILogger<Invoicing> _logger
@inject ISnackbar Snackbar
@inject SyncService SyncService

<MudText Typo="Typo.h4" GutterBottom="true">Offline Invoicing</MudText>
<MudText Class="mb-4">Create invoices here. They will be saved to the local SQLite DB and sync automatically.</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudForm @ref="form">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="newInvoice.InvoiceNumber" Label="Inv Number" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudNumericField @bind-Value="newInvoice.Amount" Label="Amount" Required="true" Adornment="Adornment.Start" AdornmentText="$" />
            </MudItem>
            <MudItem xs="12" sm="2" Class="d-flex align-end">
                <MudButton OnClick="AddInvoice" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Add">Add</MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>

<MudDataGrid @ref="dataGrid" Items="@localInvoices" Dense="true" Striped="true" Bordered="true" ReadOnly="true">
    <Columns>
        <PropertyColumn Property="x => x.InvoiceNumber" Title="Inv Number" />
        <PropertyColumn Property="x => x.Amount" Title="Amount" Format="C" />
        <PropertyColumn Property="x => x.InvoiceDate" Title="Date (UTC)" Format="g" />
        <TemplateColumn Title="Synced?" Sortable="false" Filterable="false">
            <CellTemplate>
                @if (context.Item.IsSynced)
                {
                    <MudChip T="object" Icon="@Icons.Material.Filled.CloudDone" Color="Color.Success">Synced</MudChip>
                }
                else
                {
                    <MudChip T="object" Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Warning">Pending</MudChip>
                }
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager />
    </PagerContent>
</MudDataGrid>


@code {
    private MudForm? form;
    private MudDataGrid<Invoice>? dataGrid;
    private List<Invoice> localInvoices = new();
    private Invoice newInvoice = new();

    protected override async Task OnInitializedAsync()
    {
        // The line causing the deadlock is now removed
        await LoadLocalInvoices();
        SyncService.SyncStatusChanged += async (s, e) => await InvokeAsync(RefreshData);
    }

    private async Task LoadLocalInvoices()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        localInvoices = await db.Invoices.OrderByDescending(i => i.InvoiceDate).ToListAsync();
    }

    private async Task RefreshData()
    {
        await LoadLocalInvoices();
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
        }
        StateHasChanged();
    }

    private async Task AddInvoice()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var invoice = new Invoice
            {
                Id = Guid.NewGuid(),
                InvoiceNumber = newInvoice.InvoiceNumber,
                Amount = newInvoice.Amount,
                InvoiceDate = DateTime.UtcNow,
                IsSynced = false
            };

            await db.Invoices.AddAsync(invoice);
            await db.SaveChangesAsync();

            Snackbar.Add("Invoice saved to local SQLite DB.", Severity.Success);

            newInvoice = new();
            await RefreshData();

            // Trigger a sync attempt immediately
            _ = SyncService.TrySyncInvoicesAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving to local DB.");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}